

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
  <title>LVS+keepalived - gys的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"gys18007141407.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>gys的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/miku3.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="LVS+keepalived">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-11 17:42" pubdate>
        2021年10月11日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      71
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">LVS+keepalived</h1>
	    <time updated datetime="2021-11-03 16:35"></time>
            
            <div class="markdown-body">
              <h3 id="LVS-Linux-Virtual-Server"><a href="#LVS-Linux-Virtual-Server" class="headerlink" title="LVS = Linux Virtual Server"></a>LVS = Linux Virtual Server</h3><p>(Linux虚拟服务器) </p>
<p>LVS集群采用IP负载均衡技术和基于内容请求分发技术。调取器具有很好的吞吐率，将请求均衡的转移到不同的服务器执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能，高可用的虚拟服务器。</p>
<p>linux内核支持LVS功能模块。也就是说，LVS是内核提供的一个功能模块。</p>
<p>apt install ipvsadm。使用ipvsadm命令(ipvs的管理器)来管理LVS，如果安装了keepalive，则可以通过keepalive的配置文件来管理LVS。</p>
<h4 id="相关简称"><a href="#相关简称" class="headerlink" title="相关简称"></a>相关简称</h4><p>DS：Director Server。前端负载均衡器节点。</p>
<p>RS：Real Server。后端真实的工作服务器。</p>
<p>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。</p>
<p>DIP：Director Server IP，主要用于和内部主机通讯的IP地址。</p>
<p>RIP：Real Server IP，后端服务器的IP地址。</p>
<p>CIP：Client IP，访问客户端的IP地址</p>
<h4 id="三种工作模式"><a href="#三种工作模式" class="headerlink" title="三种工作模式"></a>三种工作模式</h4><h4 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h4><p>将请求报文中的目标地址和目标端口修改为某挑RS的RIP和PORT实现转发。</p>
<p><em>路由</em></p>
<p>1、当用户请求到达DS，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</p>
<p>2、PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</p>
<p>3、IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP</p>
<p>4、POSTROUTING链通过选路，将数据包发送给RS</p>
<p>5、RS比对发现目标为自己的IP，开始构建响应报文发回给DS。 此时报文的源IP为RIP，目标IP为CIP</p>
<p>6、DS在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011170126020.png" srcset="/img/loading.gif" lazyload alt="image-20211011170126020"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011165436840.png" srcset="/img/loading.gif" lazyload alt="image-20211011165436840"></p>
<p><em>特性</em></p>
<p>1、RS应该和DIP应该使用私网地址，且RS的网关要指向DIP；</p>
<p>2、<b>请求和响应报文都要经由DS转发；极高负载的场景中，DS可能会成为系统瓶颈</b>；</p>
<p>3、支持端口映射；</p>
<p>4、RS可以使用任意OS；</p>
<p>5、RS的RIP和DS的DIP必须在同一IP网络；</p>
<p><em>缺陷</em></p>
<p>1、对DS压力会比较大，请求和响应都需经过DS</p>
<h4 id="DR"><a href="#DR" class="headerlink" title="DR"></a>DR</h4><p>(为了解决RS回送给Client的报文全部要经过DS而造成DS成为该系统的瓶颈，想一个办法使得RS可以直接给Client回送报文)</p>
<p>为请求报文重新封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变。</p>
<p><em>路由</em></p>
<p>1、当用户请求到达DS，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</p>
<p>2、PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</p>
<p>3、 IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址</p>
<p>4、 由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至RS。(RS知道VIP，所以直接修改IP源为VIP)</p>
<p>5、 RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP</p>
<p>6、 响应报文最终送达至客户端</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011170617265.png" srcset="/img/loading.gif" lazyload alt="image-20211011170617265"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011171431518.png" srcset="/img/loading.gif" lazyload alt="image-20211011171431518"></p>
<p><em>特性</em></p>
<p>1、确保前端路由器将目标IP为VIP的请求报文发往DS：</p>
<p>(a) 在前端网关做静态绑定；</p>
<p>(b) 在RS上使用arptables；</p>
<p>(c) 在RS上修改内核参数以限制arp通告及应答级别；</p>
<hr>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs tex">修改RS上内核参数（arp<span class="hljs-built_in">_</span>ignore和arp<span class="hljs-built_in">_</span>announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求(RS的VIP对外隐藏，对内可见)。<br><br>配置【每一台RS】的VIP：<br>RS &lt;====&gt; Client<br>ifconfig lo:0 192.168.162.100 netmask 255.255.255.255（配置RS的VIP，不对外响应）<br>route add -host 192.168.162.100 dev lo:0 （添加访问本地VIP的主机路由，报文目标IP为192.168.162.100的接口为lo:0。[arp<span class="hljs-built_in">_</span>ignore=1，接收到arp的网卡地址和该arp请求的网卡地址一样]DS将数据包通过链路层发送给了RS，RS的lo:0[只有lo:0的IP地址和该arp请求的网卡地址一样，故只有lo:0响应了arp]接收到了此包。回复该数据包时,[arp<span class="hljs-built_in">_</span>announce=2, 以发送网卡的IP地址作为源IP发送arp]将回复数据包的源IP设为lo:0的IP，目的IP设置为Client的IP，故RS将该数据包直接发送给了Client）<br><br><br>arp<span class="hljs-built_in">_</span>ignore参数的作用是控制系统在收到外部的arp请求时，是否要返回arp响应。<br>arp<span class="hljs-built_in">_</span>ignore参数常用的取值主要有0、1、2。3~8较少用到：<br>0：响应任意网卡上接收到的对本机IP地址的arp请求,而不管该目的IP是否在接收网卡上。[接收到arp的网卡地址和该arp请求的网卡地址在同一台计算机上]<br>1：只响应目的IP地址为接收网卡上的本地地址的arp请求。[接收到arp的网卡地址和该arp请求的网卡地址一样]<br>2：只响应目的IP地址为接收网卡上的本地地址的arp请求,并且arp请求的源IP必须和接收网卡同网段。[接收到arp的网卡地址和该arp请求的网卡地址一样，并且该arp请求的源IP跟接收到该arp请求的网卡的IP在同一个网段]<br><br>arp<span class="hljs-built_in">_</span>announce的作用是控制系统在对外发送arp请求时，如何选择arp请求数据包的源IP地址。<br>arp<span class="hljs-built_in">_</span>announce参数常用的取值有0、1、2。<br>0：允许使用任意网卡上的IP地址作为arp请求的源IP，通常就是使用数据包的源IP。[以本机上任意网卡的IP地址作为源IP发送arp]<br>1：尽量避免使用不属于该发送网卡子网的本地地址作为发送arp请求的源IP地址。[尽量以发送网卡的IP地址作为源IP发送arp]<br>2：忽略IP数据包的源IP地址，选择该发送网卡上最合适的本地地址作为arp请求的源IP地址。[以发送网卡的IP地址作为源IP发送arp]<br><br>DR模式下，每个RS节点都要在环回网卡上绑定虚拟服务IP。这时候，如果客户端对于VIP的arp请求广播到了各个真实服务器节点，如果arp<span class="hljs-built_in">_</span>ignore参数配置为0，则各RS节点都会响应该arp请求，此时客户端就无法正确获取LVS节点上正确的VIP所在网卡的MAC地址。假如某个RS节点A的网卡eth1响应了该arp请求，客户端把A节点的eth1网卡的MAC地址误认为是LVS节点的VIP所在网卡的MAC，从而将业务请求消息直接发到了A节点的eth1网卡。这时候虽然因为A节点在环回网卡上也绑定了VIP，所以A节点也能正常处理请求，业务暂时不会受到影响。但时此时由于客户端请求没有发到LVS的VIP上，所以LVS的负载均衡能力没有生效。造成的后果就是，A节点一直在单节点运行，业务量过大时可能会出现性能瓶颈。<br>所以DR模式下要求arp<span class="hljs-built_in">_</span>ignore参数要求配置为1。<br><br>每个机器或者交换机中都有一张arp表，该表用于存储对端通信节点IP地址和MAC地址的对应关系。当收到一个未知IP地址的arp请求，就会再本机的arp表中新增对端的IP和MAC记录；当收到一个已知IP地址（arp表中已有记录的地址）的arp请求，则会根据arp请求中的源MAC刷新自己的arp表。<br>如果arp<span class="hljs-built_in">_</span>announce参数配置为0，则网卡在发送arp请求时，可能选择的源IP地址并不是该网卡自身的IP地址，这时候收到该arp请求的其他节点或者交换机上的arp表中记录的该网卡IP和MAC的对应关系就不正确，可能会引发一些未知的网络问题，存在安全隐患。<br>所以DR模式下要求arp<span class="hljs-built_in">_</span>announce参数要求配置为2<br><br>更改方式：<br>1、更改arp<span class="hljs-built_in">_</span>ignore和arp<span class="hljs-built_in">_</span>announce文件<br>不能直接用vim编辑arp<span class="hljs-built_in">_</span>ignore和arp<span class="hljs-built_in">_</span>announce文件,使用重定向来向文件中输入字符<br>echo 1 &gt;/proc/sys/net/ipv4/conf/lo/arp<span class="hljs-built_in">_</span>ignore<br>echo 2 &gt;/proc/sys/net/ipv4/conf/lo/arp<span class="hljs-built_in">_</span>announce<br>echo 1 &gt;/proc/sys/net/ipv4/conf/all/arp<span class="hljs-built_in">_</span>ignore<br>echo 2 &gt;/proc/sys/net/ipv4/conf/all/arp<span class="hljs-built_in">_</span>announce<br>2、修改系统变量/etc/sysctl.conf文件，然后用命令sysctl -p刷新到内存。<br>net.ipv4.conf.all.arp<span class="hljs-built_in">_</span>ignore=1<br>net.ipv4.conf.lo.arp<span class="hljs-built_in">_</span>ignore=1<br>net.ipv4.conf.all.arp<span class="hljs-built_in">_</span>announce=2<br>net.ipv4.conf.lo.arp<span class="hljs-built_in">_</span>announce=2<br>3、使用命令sysctl -w直接写入内存：<br>sysctl -w net.ipv4.conf.all.arp<span class="hljs-built_in">_</span>ignore=1<br>sysctl -w net.ipv4.conf.lo.arp<span class="hljs-built_in">_</span>ignore=1<br>sysctl -w net.ipv4.conf.all.arp<span class="hljs-built_in">_</span>announce=2<br>sysctl -w net.ipv4.conf.lo.arp<span class="hljs-built_in">_</span>announce=2<br><br><br>配置DS的VIP:<br>ifconfig ens33:0 192.168.162.100 netmask 255.255.255.0 （配置DS的VIP）<br>echo 1 &gt;/proc/sys/net/ipv4/ip<span class="hljs-built_in">_</span>forward （开启路由转发功能，ens33:0。出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将包发往本机另一网卡，该网卡根据路由表继续发送数据包。这通常就是路由器所要实现的功能。）<br><br>配置DS调度器<br>ipvsadm -A -t 192.168.162.100:80 -s rr<br>ipvsadm -a -t 192.168.162.100:80 -r 192.168.162.129 -g (可通过-w来设置权重, 默认-w 1)<br>ipvsadm -a -t 192.168.162.100:80 -r 192.168.162.130 -g (可通过-w来设置权重, 默认-w 1)<br></code></pre></td></tr></table></figure>

<hr>
<p>2、RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由DS；</p>
<p>3、RS跟Director要在同一个物理网络；</p>
<p>4、请求报文要经由DS，但响应不能经由DS，而是由RS直接发往Client；</p>
<p>5、不支持端口映射；</p>
<p><em>缺陷</em></p>
<p>1、RS和DS必须在同一局域网内</p>
<h4 id="TUN"><a href="#TUN" class="headerlink" title="TUN"></a>TUN</h4><p>在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP)</p>
<p><em>路由</em></p>
<p>1、当用户请求到达DS，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。</p>
<p>2、 PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</p>
<p>3、IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP</p>
<p>4、 POSTROUTING链根据最新封装的IP报文，将数据包发至RS（隧道传输）。 此时源IP为DIP，目标IP为RIP</p>
<p>5、 RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP</p>
<p>6、响应报文最终送达至客户端</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011172926837.png" srcset="/img/loading.gif" lazyload alt="image-20211011172926837"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211011171854193.png" srcset="/img/loading.gif" lazyload alt="image-20211011171854193"></p>
<p><em>特性</em></p>
<p>1、DIP, VIP, RIP都应该是公网地址；</p>
<p>2、RS的网关不能，也不可能指向DIP；</p>
<p>3、请求报文要经由Director，但响应不能经由Director；</p>
<p>4、不支持端口映射；</p>
<p>5、RS的OS得支持隧道功能；</p>
<p><em>缺陷</em></p>
<p>1、隧道模式的RS节点需要合法IP，这种方式需要所有的服务器均支持“IP Tunneling”。</p>
<h4 id="常用调度算法"><a href="#常用调度算法" class="headerlink" title="常用调度算法"></a>常用调度算法</h4><p>• <strong>轮询（Round Robin）</strong></p>
<p>将收到的访问请求按照顺序轮流分配给群集中的各节点（真实服务器），均等地对待每一台服务器，而不是服务器实际的连接数和系统负载</p>
<p>• <strong>加权轮询（Weighted Round Robin）</strong></p>
<p>根据调度设置的权重值来分发请求，权重值高的节点优先获得任务，分配的请求数越多</p>
<p>保证性能强的服务器承担更多的访问流量</p>
<p>• <strong>最少连接 （Least Connections）</strong></p>
<p>根据真实服务器已建立的连接进行分配，将收到的访问请求优先分配给连接数最少的节点</p>
<p>• <strong>加权最少连接（Weighted Least Connections）</strong></p>
<p>在服务器节点的性能差异较大时，可以为真实服务器自动调整权重</p>
<p>性能较高的节点承担更大比例的活动连接负载</p>
<h4 id="DR配置示例"><a href="#DR配置示例" class="headerlink" title="DR配置示例"></a>DR配置示例</h4><h5 id="使用ipvsadm"><a href="#使用ipvsadm" class="headerlink" title="使用ipvsadm"></a>使用ipvsadm</h5><p><code>apt install ipvsadm</code></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tex">ipvsadm 工具选项说明：<br>-A：添加虚拟服务器<br>-D：删除整个虚拟服务器<br>-s：指定负载调度算法（轮询：rr、加权轮询：wrr、最少连接：lc、加权最少连接：wlc）<br>-a：表示添加真实服务器（节点服务器）<br>-d：删除某一个节点<br>-t：指定 VIP地址及 TCP端口<br>-r：指定 RIP地址及 TCP端口<br>-m：表示使用 NAT群集模式<br>-g：表示使用 DR模式<br>-i：表示使用 TUN模式<br>-w：设置权重（权重为 0 时表示暂停节点）<br>-p 60：表示保持长连接60秒<br>-l：列表查看 LVS 虚拟服务器（默认为查看所有）<br>-n：以数字形式显示地址、端口等信息，常与“-l”选项组合使用。ipvsadm -ln<br></code></pre></td></tr></table></figure>

<p>一、配置RS</p>
<p>配置第一个RS (192.168.162.129)</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012134222185.png" srcset="/img/loading.gif" lazyload alt="image-20211012134222185"></p>
<p>同理配置第二个RS (192.168.162.130)</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012134440462.png" srcset="/img/loading.gif" lazyload alt="image-20211012134440462"></p>
<p>二、配置DS (192.168.162.128)</p>
<p>1、配置VIP</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012134759615.png" srcset="/img/loading.gif" lazyload alt="image-20211012134759615"></p>
<p>2、开启路由转发功能</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012135009851.png" srcset="/img/loading.gif" lazyload alt="image-20211012135009851"></p>
<p>3、配置LVS</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012135335140.png" srcset="/img/loading.gif" lazyload alt="image-20211012135335140"></p>
<p>三、测试</p>
<p>分别在RS中部署nginx服务器，Client使用postman请求VIP看能否得到响应。</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012135707422.png" srcset="/img/loading.gif" lazyload alt="image-20211012135707422"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012135725098.png" srcset="/img/loading.gif" lazyload alt="image-20211012135725098"></p>
<p>成功！Client以轮询方式获取到了两台RS中的nginx页面。（注意Connection: close不要持久连接）</p>
<p>Client开启持久连接后，通过netstat -natp查看DS和RS的tcp连接情况, 可以看到Client和某一个RS建立了tcp连接，DS只负责IP层的转发因而不与Client建立连接。</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211012140309877.png" srcset="/img/loading.gif" lazyload alt="image-20211012140309877"></p>
<h3 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h3><p><code>apt install keepalived</code></p>
<p>上述设计存在<b>单点故障</b>，比如某个RS已经挂了，那么一部分负载给该RS的数据包就相当于丢失了。再比如DS挂了，那么整个系统直接瘫痪了。</p>
<p>使用<b>keepalived来实现高可用(HA)</b>： Keekpalived通过<code>vrrp</code>协议(<code>Virtual Router Redundancy Protocol</code>)实现。</p>
<p><strong>注意：</strong>DS的时间需要统一。一些可能有用的<a target="_blank" rel="noopener" href="https://www.cnblogs.com/haoworld/p/nginxlvskeepalivednginx-shi-xian-gao-xing-neng-fu-.html">信息</a></p>
<hr>
<p>如果在没有部署VRRP之前，两台互相备份和负载分担的设备就存在2个不同的IP地址，都可以充当某个集群的网关，而他们又没有很好的检测机制来判断目前网关是否出故障，从而方便的进行切换。如果没有VRRP之前，则只能通过人工进行修改。这个工作量是非常巨大的。特别是在大型网络当中，非常不实际。</p>
<p>所以，VRRP解决的问题就是，通过VRRP技术协商，虚拟一个IP地址出来（VRRP可能直接使用某个接口地址），这样做的好处就是，备用设备只需要定义VRRP虚拟的那个IP地址作为网关即可，当主设备故障出现故障后，会自动切换到备用上面，从而对客户来说是透明的。</p>
<p> 在一个一主多备的Keepalived集群中，priority值最大的将成为集群中的Master节点，而其他都是Backup节点。在Master节点发生故障后，Backup节点之间将进行“民主选举”，<b>通过对节点优先级值priority和weight的计算，选出新的MASTER节点</b>接管集群服务。</p>
<hr>
<h4 id="keepalived作用"><a href="#keepalived作用" class="headerlink" title="keepalived作用"></a>keepalived作用</h4><p>1、管理VIP(管理LVS)：即存在主备分发器(主备DS)，当主分发器挂掉时，VIP自动转移到备分发器上，这时备分发器作为新的主分发器。当主分发器修复后，由于主分发器比备分发器的优先级高，故VIP又会从备分发器转移到原先的主分发器上。</p>
<p>2、对LVS集群节点做健康检查：在Keepalived服务正常工作时，<b>Master节点会不断地向Backup节点发送（组播的方式）心跳消息 (VRRP 报文)，用以告诉Backup节点自己还处于健康状态</b>，当Master节点发生故障时，就无法发送心跳消息，Backup节点无法检测到来自Master节点心跳了，于是调用自身的接管程序，接管Master节点的IP资源及服务，转为Master角色。而当Master节点恢复时，Backup节点又会释放Master节点故障时自身接管的IP资源及服务，恢复到原来的Backup角色。</p>
<p>3、对RS集群节点做健康检查：keepalived会定期访问RS（常用的方式包括<strong>tcp_check</strong> <strong>和http_get</strong>），看是否正常。如果不正常，则剔除该RS。</p>
<h4 id="keepalived工作方式"><a href="#keepalived工作方式" class="headerlink" title="keepalived工作方式"></a>keepalived工作方式</h4><p>1、抢占式</p>
<p>直接设置某个DS为Master角色，其他DS为Backup角色。当Master角色恢复成健康状态后直接抢占当前暂任Master的Backup角色的IP资源及服务，继续担任Master角色，而暂任Master的Backup则恢复成Backup角色。</p>
<p>2、非抢占式</p>
<p>没有主从之分，所有DS均为Backup，并且要在所有DS中keepalived配置nopreempt来标志非抢占式。</p>
<h4 id="keepalived健康检查方式"><a href="#keepalived健康检查方式" class="headerlink" title="keepalived健康检查方式"></a>keepalived健康检查方式</h4><p>• <strong>TCP_CHECK：</strong>工作在第4层，keepalived向RS发起一个tcp连接请求，如果RS没有响应或超时，那么这个RS将从服务器池中移除。</p>
<p>• <strong>HTTP_GET：</strong>工作在第5层，向指定的URL执行http请求，将得到的结果用md5加密并与指定的md5值比较看是否匹配，不匹配则从服务器池中移除；此外还可以指定http返回码来判断检测是否成功。HTTP_GET可以指定多个URL用于检测，这个一台服务器有多个虚拟主机的情况下比较好用。</p>
<p>• <strong>SSL_GET：</strong>跟上面的HTTP_GET相似，不同的只是用SSL连接</p>
<p>• <strong>MISC_CHECK：</strong>用脚本来检测，脚本如果带有参数，需将脚本和参数放入双引号内。脚本的退出值(exit 0;)需为：<code>0: 检测成功。1: 检测失败，将从服务器池中移除。2－255: 检测成功。</code>如果定义了字段misc_dynamic，表示当故障时将RS权重改为返回值减去2。如返回值为51，该RS权重自动调整为49。</p>
<p>• <strong>SMTP_CHECK：</strong>检测邮件服务</p>
<h4 id="keepalived配置文件模板"><a href="#keepalived配置文件模板" class="headerlink" title="keepalived配置文件模板"></a>keepalived配置文件模板</h4><p>一些帮助信息：</p>
<p>1、<code>man 5 keepalived.conf</code>2、<a target="_blank" rel="noopener" href="https://blog.51cto.com/wangaimin/2465827">博客</a></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino">解释一下：<br><span class="hljs-number">1</span>是普通的命令<br><span class="hljs-number">2</span>是系统调用,如open,write之类的(通过这个，至少可以很方便的查到调用这个函数，需要加什么头文件)<br><span class="hljs-number">3</span>是C库函数,如printf,fread<br><span class="hljs-number">4</span>是特殊文件,也就是/dev下的各种设备文件<br><span class="hljs-number">5</span>是指文件的格式,比如passwd, 就会说明这个文件中各个字段的含义<br><span class="hljs-number">6</span>是给游戏留的,由各个游戏自己定义<br><span class="hljs-number">7</span>是附件还有一些变量,比如向environ这种全局变量在这里就有说明<br><span class="hljs-number">8</span>是系统管理用的命令,这些命令只能由root使用,如ifconfig<br></code></pre></td></tr></table></figure>

<p>Master的/etc/keepalived/keepalived.conf文件</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-params">#</span> 全局定义模块<br>! Configuration File for keepalived<br><br>global<span class="hljs-built_in">_</span>defs &#123;<br>  notification<span class="hljs-built_in">_</span>email &#123;<br>    acassen@firewall.loc<br>    failover@firewall.loc<br>    sysadmin@firewall.loc              <span class="hljs-params">#</span> 邮件报警，可以不设置，后期nagios统一监控。<br>  &#125;<br>  <br>  notification<span class="hljs-built_in">_</span>email<span class="hljs-built_in">_</span>from Alexandre.Cassen@firewall.loc<br>  <br>  smtp<span class="hljs-built_in">_</span>server 192.168.162.128<br>  <br>  smtp<span class="hljs-built_in">_</span>connect<span class="hljs-built_in">_</span>timeout 30<br>  <br>  router<span class="hljs-built_in">_</span>id LVS<span class="hljs-built_in">_</span>DEVEL                  <span class="hljs-params">#</span> 此处注意router<span class="hljs-built_in">_</span>id为负载均衡标识。【本服务器的名称，备份组内唯一】<br>  <br>  vrrp<span class="hljs-built_in">_</span>skip<span class="hljs-built_in">_</span>check<span class="hljs-built_in">_</span>adv<span class="hljs-built_in">_</span>addr<br>  <br>  <span class="hljs-params">#</span> vrrp<span class="hljs-built_in">_</span>strict                          <span class="hljs-params">#</span> 严格遵守VRRP协议。【未验证！==&gt;若包含字段vrrp<span class="hljs-built_in">_</span>strict则下列情况将会阻止启动Keepalived：1. 没有VIP地址。2. 单播。3. 在VRRP版本2中有IPv6地址。】<br>  <br>  vrrp<span class="hljs-built_in">_</span>garp<span class="hljs-built_in">_</span>interval 0.001             <span class="hljs-params">#</span> 免费ARP的通告间隔用于IPV4<br>  <br>  vrrp<span class="hljs-built_in">_</span>gna<span class="hljs-built_in">_</span>interval 0.000001           <span class="hljs-params">#</span> 免费NA的通告间隔用于IPV6<br>&#125;<br><br><br><span class="hljs-params">#</span> VRRP实例定义块<br>vrrp<span class="hljs-built_in">_</span>instance VI<span class="hljs-built_in">_</span>1 &#123;<br>    state MASTER 		               <span class="hljs-params">#</span> 状态只有MASTER和BACKUP两种，并且要大写，MASTER为工作状态，BACKUP是备用状态。<br>    <br>    interface ens33					   <span class="hljs-params">#</span> 承载VIP地址的物理接口<br>    <br>    lvs<span class="hljs-built_in">_</span>sync<span class="hljs-built_in">_</span>daemon<span class="hljs-built_in">_</span>interface ens33    <span class="hljs-params">#</span> DS之间的心跳监控接口(DR模式中同interface)。<br>        <br>    virtual<span class="hljs-built_in">_</span>router<span class="hljs-built_in">_</span>id 55               <span class="hljs-params">#</span> 虚拟路由标识，同一个vrrp<span class="hljs-built_in">_</span>instance的MASTER和BACKUP的虚拟路由标识是一致的。【服务分区,每一个vrrp<span class="hljs-built_in">_</span>instance对应一个服务】<br>    <br>    priority 100                       <span class="hljs-params">#</span> 优先级，同一个vrrp<span class="hljs-built_in">_</span>instance的MASTER优先级必须比BACKUP高。<br>    <br>    advert<span class="hljs-built_in">_</span>int 1                       <span class="hljs-params">#</span> MASTER与BACKUP之间同步检查的时间间隔，单位为秒。(组播信息发送间隔，两个节点设置必须一样，默认 1s)<br>    <br>    authentication &#123;<br>        auth<span class="hljs-built_in">_</span>type PASS                 <span class="hljs-params">#</span> 验证authentication。包含验证类型和验证密码。类型主要有PASS、AH 两种，通常使用的类型为PASS。<br>        <br>		auth<span class="hljs-built_in">_</span>pass 1407                 <span class="hljs-params">#</span> 此密码最多只支持八位数，最好不要有特殊字符、汉字。验证密码为明文，同一vrrp 实例MASTER 与BACKUP 使用相同的密码才能正常通信。<br>    &#125;<br>    <br>    virtual<span class="hljs-built_in">_</span>ipaddress &#123;                <span class="hljs-params">#</span> VIP,可以有多个地址，每个地址占一行，不需要子网掩码，同时这个ip必须与我们在RS设定的vip一致！<br>        192.168.162.100 dev ens33 label ens33:0<br>        <span class="hljs-params">#</span> 192.168.162.101<br>        <span class="hljs-params">#</span> 192.168.162.102<br>    &#125;<br>&#125;<br><br><br><span class="hljs-params">#</span> 虚拟服务器定义块<br>virtual<span class="hljs-built_in">_</span>server 192.168.162.100 80 &#123;   <span class="hljs-params">#</span> VIP，来源于上面的VIP地址，后面加空格加端口号<br>    delay<span class="hljs-built_in">_</span>loop 6                      <span class="hljs-params">#</span> 健康检查间隔，单位为秒<br>    <br>    lb<span class="hljs-built_in">_</span>algo rr                        <span class="hljs-params">#</span> 负载均衡调度算法，一般用wrr、rr、wlc<br>    <br>    lb<span class="hljs-built_in">_</span>kind DR                        <span class="hljs-params">#</span> 负载均衡转发规则。一般包括DR,NAT,TUN 3种。<br>    <br>    persistence<span class="hljs-built_in">_</span>timeout 0             <span class="hljs-params">#</span> 会话保持时间(秒)，在该时间段内同一IP连接会被分配到同一台服务器。【不然用户可能刚在服务器1上提交完帐号密码，就跳转到另一台服务器2上了】【经测试! ==&gt; 若该选项不为0，则rr算法没用按照预想的方式切换RS，每次都负载到了同一个RS上】<br>    <br>    protocol TCP                      <span class="hljs-params">#</span> 转发协议，有TCP和UDP两种。<br>	<br>    real<span class="hljs-built_in">_</span>server 192.168.162.129 80 &#123;  <span class="hljs-params">#</span> RS，包括IP和端口号<br>        weight 1                      <span class="hljs-params">#</span> 权重<br>        <br>        TCP<span class="hljs-built_in">_</span>CHECK &#123;                   <span class="hljs-params">#</span> 通过tcp<span class="hljs-built_in">_</span>check判断RS的健康状态<br>            connect<span class="hljs-built_in">_</span>timeout 3         <span class="hljs-params">#</span> 连接超时时间<br>            retry 3            		  <span class="hljs-params">#</span> 重连次数<br>            delay<span class="hljs-built_in">_</span>before<span class="hljs-built_in">_</span>retry 3      <span class="hljs-params">#</span> 重连时间间隔<br>            connect<span class="hljs-built_in">_</span>port 80           <span class="hljs-params">#</span> 检测端口<br>        &#125;<br>        <br><br>        HTTP<span class="hljs-built_in">_</span>GET &#123;					  <span class="hljs-params">#</span> 通过http<span class="hljs-built_in">_</span>get判断RS的健康状态<br>            url &#123;<br>                path /<br>                status<span class="hljs-built_in">_</span>code 200       <span class="hljs-params">#</span> 返回状态码<br>            &#125;<br>            connect<span class="hljs-built_in">_</span>timeout 3         <span class="hljs-params">#</span> 连接超时时间<br>            retry 3            		  <span class="hljs-params">#</span> 重连次数<br>            delay<span class="hljs-built_in">_</span>before<span class="hljs-built_in">_</span>retry 3      <span class="hljs-params">#</span> 重连时间间隔<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-params">#</span> 其实配置文件中主要要修改的选项没有很多，有三个参数要注意<br><span class="hljs-params">#</span> route<span class="hljs-built_in">_</span>id  XXX                       <span class="hljs-params">#</span> MASTER和BACKUP不同<br><span class="hljs-params">#</span> virtual<span class="hljs-built_in">_</span>router<span class="hljs-built_in">_</span>id 51                <span class="hljs-params">#</span> 同一个实例下，MASTER和BACKUP相同<br><span class="hljs-params">#</span> priority 100                        <span class="hljs-params">#</span> 优先级，同一个实例下，MASTER高于BACKUP<br></code></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>对于RS，均按照上述ipvsadm中所述配置。</p>
<p>对于DS中的Master使用上述配置文件；Backup也使用上述文件，但是将state设置为BACKUP，将priority设置为50。</p>
<p>接下来，测试DS的MASTER, BACKUP模式(即抢占模式)。先开启BACKUP，然后开启MASTER：</p>
<p><strong>BACKUP：</strong>Backup开启后首先是进入了Backup状态，然后组播自己的priority，由于目前该Backup具有最高的priority，故当前Backup成为了新的Master。后来，真正的Master开启，该Backup收到了具有更大priority的组播信息，于是让出IP资源和服务，重新回到Backup状态，VIP被down掉(IP漂移)，因为只有Master才真正具有VIP。</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211013164844754.png" srcset="/img/loading.gif" lazyload alt="image-20211013164844754"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211013171155821.png" srcset="/img/loading.gif" lazyload alt="image-20211013171155821"></p>
<p><strong>MASTER：</strong>Master开启后首先是进入了Backup状态，然后组播自己的priority，最后理所应当的成为了新的Master。</p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211013164908386.png" srcset="/img/loading.gif" lazyload alt="image-20211013164908386"></p>
<p><img src="/2021/10/11/LVS+keepalived%E9%85%8D%E7%BD%AE/image-20211013171339810.png" srcset="/img/loading.gif" lazyload alt="image-20211013171339810"></p>
<h4 id="keepalived脑裂"><a href="#keepalived脑裂" class="headerlink" title="keepalived脑裂"></a>keepalived脑裂</h4><p>脑裂（split-brain) 是指在一个高可用（HA）系统中，当联系着的两个节点断开联系时，本来为一个整体的系统，分裂为两个独立节点，这时两个节点开始争抢共享资源，结果会导致系统混乱，数据损坏。</p>
<p>对于无状态服务的HA，无所谓脑裂不脑裂；但对有状态服务(比如MySQL)的HA，必须要严格防止脑裂。</p>
<p>可能的解决方式：</p>
<p>1、当LVS使用DR工作模式时，由于DS和RS在同一个局域网下，故而所有DS也应该在用一个局域网下。这个工作模式下，可以为DS编写shell脚本用来循环ping该DS的网关，如果连续失败一定次数则关闭该DS的keepalived服务，当发现能ping通时再来重启keepalived服务。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
                    
                      <a class="hover-with-bg" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
                    
                      <a class="hover-with-bg" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-info">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/11/%E6%AC%A7%E6%8B%89%E5%87%BD%E6%95%B0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">欧拉函数</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/10/%E5%A4%9A%E9%87%8D%E8%83%8C%E5%8C%85%E7%9A%84%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97%E4%BC%98%E5%8C%96/">
                        <span class="hidden-mobile">多重背包的单调队列优化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
